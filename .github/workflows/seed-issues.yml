name: "Seed Issues (validate + sync)"

on:
  pull_request:
    paths:
      - "issues/seed.json"
      - "schemas/issues.seed.schema.json"
      - "scripts/seed-issues.sh"
      - ".github/workflows/seed-issues.yml"
  push:
    branches: ["main"]
    paths:
      - "issues/seed.json"
      - "schemas/issues.seed.schema.json"
      - "scripts/seed-issues.sh"
      - ".github/workflows/seed-issues.yml"

permissions:
  contents: write
  issues: write
  pull-requests: write
  projects: write

env:
  REPO_DEFAULT: rick1330/flakeradar-program
  PROJECT_OWNER: rick1330
  PROJECT_TITLE: FlakeRadar Roadmap

jobs:
  validate-and-dryrun:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install ajv-cli
        run: npm i -g ajv-cli
      - name: Validate seed.json against schema
        id: validate
        continue-on-error: true
        run: |
          ajv validate -s schemas/issues.seed.schema.json -d issues/seed.json --spec=draft2020 --strict=true
      - name: Dry-run seeding (no writes)
        if: steps.validate.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: "1"
        run: bash scripts/seed-issues.sh
      - name: Prepare PR summary (validation failed)
        if: steps.validate.outcome != 'success'
        run: |
          echo "### Issue Seed Validation Failed" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          ajv validate -s schemas/issues.seed.schema.json -d issues/seed.json --spec=draft2020 --strict=true 2>> "$GITHUB_STEP_SUMMARY" || true
          echo "\`\`\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Please fix schemas/issues.seed.schema.json or issues/seed.json." >> "$GITHUB_STEP_SUMMARY"
      - name: Comment summary on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          num=${{ github.event.pull_request.number }}
          if [ -s "$GITHUB_STEP_SUMMARY" ]; then
            gh pr comment "$num" --body-file "$GITHUB_STEP_SUMMARY"
          else
            gh pr comment "$num" --body "Seed workflow ran. See job logs for details."
          fi

  apply-on-main:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install ajv-cli
        run: npm i -g ajv-cli
      - name: Validate seed.json against schema
        run: ajv validate -s schemas/issues.seed.schema.json -d issues/seed.json --spec=draft2020 --strict=true
      - name: Apply seeding (create/update/close)
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN_SEED || secrets.GITHUB_TOKEN }}
          CLOSE_MISSING: "1"
        run: bash scripts/seed-issues.sh
      - name: Commit updated issues/map.json (if changed)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "flakeradar-bot"
          git config user.email "actions@users.noreply.github.com"
          if [[ -n "$(git status --porcelain issues/map.json)" ]]; then
            git add issues/map.json
            git commit -m "ci(seed): update issues map [skip ci]"
            git push "https://${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
          else
            echo "No map changes to commit."
          fi